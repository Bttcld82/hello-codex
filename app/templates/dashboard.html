{% extends "base.html" %}
{% block title %}Dashboard - Worktime Tracker{% endblock %}
{% block content %}
  <div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3">Dashboard</h1>
  </div>
  <form method="get" class="row g-3 mb-4">
    <div class="col-md-3">
      {{ form.start_date.label(class_="form-label") }}
      {{ form.start_date(class_="form-control") }}
    </div>
    <div class="col-md-3">
      {{ form.end_date.label(class_="form-label") }}
      {{ form.end_date(class_="form-control") }}
    </div>
    <div class="col-md-3">
      {{ form.project_id.label(class_="form-label") }}
      {{ form.project_id(class_="form-select") }}
    </div>
    <div class="col-md-3">
      {{ form.person_id.label(class_="form-label") }}
      {{ form.person_id(class_="form-select") }}
    </div>
    <div class="col-md-3">
      <div class="form-check mt-4">
        {{ form.include_inactive(class_="form-check-input", id="include_inactive") }}
        <label class="form-check-label" for="include_inactive">Includi inattivi</label>
      </div>
    </div>
    <div class="col-md-3 align-self-end">
      <button type="submit" class="btn btn-primary">Applica filtri</button>
    </div>
  </form>
  <div class="row mb-4">
    <div class="col-md-4">
      <div class="card text-bg-light">
        <div class="card-body">
          <h2 class="card-title h5">Ore totali</h2>
          <p class="display-6">{{ '%.2f'|format(data.total_hours) }}</p>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-bg-light">
        <div class="card-body">
          <h2 class="card-title h5">Top progetti</h2>
          <ul class="list-unstyled mb-0">
            {% for name, hours in data.hours_by_project %}
              <li><strong>{{ name }}</strong>: {{ '%.2f'|format(hours) }} h</li>
            {% else %}
              <li>Nessun dato</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
    <div class="col-md-4">
      <div class="card text-bg-light">
        <div class="card-body">
          <h2 class="card-title h5">Ore per persona</h2>
          <ul class="list-unstyled mb-0">
            {% for name, hours in data.hours_by_person %}
              <li><strong>{{ name }}</strong>: {{ '%.2f'|format(hours) }} h</li>
            {% else %}
              <li>Nessun dato</li>
            {% endfor %}
          </ul>
        </div>
      </div>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="h5">Ore per progetto</h2>
      <canvas id="chartProject"></canvas>
    </div>
    <div class="col-md-6">
      <h2 class="h5">Ore per giorno</h2>
      <canvas id="chartDaily"></canvas>
    </div>
  </div>
{% endblock %}
{% block scripts %}
  {{ super() }}
  <script>
    const projectData = {{ data.hours_by_project|tojson }};
    const dailyData = {{ data.hours_by_day|tojson }};

    const projectCtx = document.getElementById('chartProject');
    if (projectCtx) {
      new Chart(projectCtx, {
        type: 'bar',
        data: {
          labels: projectData.map(item => item[0]),
          datasets: [{
            label: 'Ore',
            data: projectData.map(item => item[1]),
            backgroundColor: '#0d6efd'
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }

    const dailyCtx = document.getElementById('chartDaily');
    if (dailyCtx) {
      new Chart(dailyCtx, {
        type: 'line',
        data: {
          labels: dailyData.map(item => item[0]),
          datasets: [{
            label: 'Ore',
            data: dailyData.map(item => item[1]),
            borderColor: '#198754',
            tension: 0.3,
            fill: false
          }]
        },
        options: {
          scales: {
            y: { beginAtZero: true }
          }
        }
      });
    }
  </script>
{% endblock %}
